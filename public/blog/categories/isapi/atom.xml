<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ISAPI | Mike Murray]]></title>
  <link href="http://mkmurray.com/blog/categories/isapi/atom.xml" rel="self"/>
  <link href="http://mkmurray.com/"/>
  <updated>2012-12-01T22:38:47-07:00</updated>
  <id>http://mkmurray.com/</id>
  <author>
    <name><![CDATA[Mike Murray]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[IIS 7 and ASP.NET Providers (Membership, Roles, and Profile)]]></title>
    <link href="http://mkmurray.com/blog/2009/02/17/iis-7-and-asp-net-providers-membership-roles-and-profile/"/>
    <updated>2009-02-17T17:38:00-07:00</updated>
    <id>http://mkmurray.com/blog/2009/02/17/iis-7-and-asp-net-providers-membership-roles-and-profile</id>
    <content type="html"><![CDATA[<div class='post'>
<p>I talked at length about the ASP.NET <a href="http://en.wikipedia.org/wiki/Provider_model">Provider Model pattern</a> and the ease of implementing several built-in services you can have for free with ASP.NET 2.0 in <a title="ASP.NET Providers - Membership, Role, and Profile" href="http://murrayon.net/2009/01/aspnet-providers-membership-role-and.html">my previous series of posts</a>.&#160; In this post, I will be discussing the advantages of using the ASP.NET Provider system under IIS 7 found in Windows Vista and Server 2008.&#160; I will also talk about an issue with using this Provider system to try and add authentication to an ASP.NET website that contains non-ASP.NET content, like static HTML pages.&#160; I think I'll start with the discussion about non-ASP.NET content first.</p> <span class='fullpost'> <h3>IIS 7.0 Integrated Pipeline</h3>  <p>Since I don't really understand much about <a title="Internet Server Application Programming Interface" href="http://en.wikipedia.org/wiki/ISAPI">ISAPI</a> filters and such, I'm just going to quote stuff from random pages on the <a href="http://www.iis.net/">official Microsoft IIS site</a>:</p>  <blockquote>   <p>&quot;IIS 6.0 and previous versions allowed the development of .NET application components via the ASP.NET platform. ASP.NET integrated with IIS via an ISAPI extension, and exposed its own application and request processing model. This effectively exposed two separate server pipelines, one for native ISAPI filters and extension components, and another for managed application components. ASP.NET components would execute entirely inside the ASP.NET ISAPI extension bubble and only for requests mapped to ASP.NET in the IIS script map configuration.</p>    <p>&quot;IIS 7.0 integrates the ASP.NET runtime with the core web server, providing a unified request processing pipeline that is exposed to both native and managed components known as modules.&quot;</p> </blockquote>  <p>and...</p>  <blockquote>   <p>&quot;This allows developers to fully extend the IIS 7.0 server with the richness of ASP.NET 2.0 and the .NET Framework, instead of using the lower level IIS C++ APIs. Existing ASP.NET applications also immediately benefit from tighter integration using existing ASP.NET features like Forms Authentication, Roles, and Output Caching for all content.&quot;</p> </blockquote>  <p>Note the last three words there:&#160; &quot;<font face="Courier New">for all content.</font>&quot;&#160; When I started this endeavor to implement the ASP.NET Provider system, I didn't realize that it would really only apply to ASP.NET content and pages.&#160; I didn't realize on IIS 6 I would have to fiddle with ISAPI filters and content filters to make my implementation work.&#160; And when I tried to doing a mapping (like <font face="Courier New">*.html</font> to the ASP.NET ISAPI DLL), I either didn't do it right or it just isn't very reliable and stable; here is a link to <a title="IIS problems with forms authentication &amp; HTML pages" href="http://forums.asp.net/t/1184547.aspx">the thread I followed in trying to make the appropriate changes in IIS 6</a>.&#160; I will note however that <a href="http://www.ultidev.com/products/Cassini/index.htm">UltiDev's Cassini Web Server</a> can host such a site with absolutely no extra modification, where even IIS 7 required a little configuration.</p>  <p>By default in IIS 7, an <a title="IIS and ASP.NET: The Application Pool" href="http://www.developer.com/net/asp/article.php/2245511">application pool</a> runs using the <font face="Courier ne">Integrated</font> mode for the <font face="Courier New">Managed Pipeline</font> configuration.&#160; But there is also the option of <font face="Courier New">Classic</font> mode, which is helpful if you are needing strict compatibility with how you ran a website under IIS 6.&#160; In many cases, however, an existing ASP.NET website runs under <font face="Courier New">Integrated</font> mode without any problems.</p>  <h3>Configuring an ASP.NET Website to Run on IIS 7</h3>  <p>First, I think I will point you to a great video and document on Microsoft's official IIS site that explains everything you really need to know.&#160; Then I will emphasize a few of the important points and also a gotcha or two.&#160; Here are the links you should reference:</p>  <ul>   <li><a href="http://learn.iis.net/page.aspx/377/using-aspnet-forms-authentication/">Using ASP.NET Forms Authentication</a> (video) </li>    <li><a href="http://learn.iis.net/page.aspx/243/aspnet-integration-with-iis7/">ASP.NET Integration with IIS 7.0</a> </li> </ul>  <p>The video above is also a terrific introduction to IIS 7.&#160; Below is a screenshot of IIS's UI for configuring a website:</p>  <p><a href="http://lh6.ggpht.com/_rps657FzHZ0/SZtZDNleinI/AAAAAAAAACw/b2kq_6XIGD8/s1600-h/IIS_screenshot%5B5%5D.png"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" border="0" alt="IIS_screenshot" src="http://lh5.ggpht.com/_rps657FzHZ0/SZtZDjlrIRI/AAAAAAAAAC0/cC29GwiAIhk/IIS_screenshot_thumb%5B3%5D.png?imgmax=800" width="475" height="368" /></a> </p>  <p>Notice the <font face="Courier New">ASP.NET</font> section and how it's able to use your Providers to bring back Users, Roles, and Profile data back from the database.&#160; This UI reads from and writes to your <font face="Courier New">Web.config</font> and is really slick in my opinion.</p>  <p>The only real &quot;breaking change&quot; for running your website under IIS 7 is the fact that your <font face="Courier New">Web.config</font> might need a little migration to be compatible with <font face="Courier New">Integrated</font> mode.&#160; Apparently IIS gives you helpful error messages if it detects you haven't run through the migration yet.&#160; The two most common things that ASP.NET websites have that require this migration are if you have declared <font face="Courier New">httpModules</font> or <font face="Courier New">httpHandlers</font> in your <font face="Courier New">Web.config</font>.&#160; The fix is to either copy or move these sections under <font face="Courier New">system.web</font> to their corresponding <font face="Courier New">system.webServer</font> sections.&#160; If you duplicate the sections, then you should be able run under both <font face="Courier New">Integrated</font> and <font face="Courier New">Classic</font> modes without any problems.&#160; You can even still run on IIS 6 I believe, as IIS 6 will ignore this new section called <font face="Courier New">system.webServer</font> which is IIS 7 specific.&#160; IIS 7 even provides a utility that can perform this migration for you; here is the what you would type in a Command Prompt:</p>  <p><font face="Courier New">%windir%\system32\inetsrv\APPCMD.EXE migrate config &lt;Application Path&gt;</font></p>  <p>...where <font face="Courier New">&lt;Application Path&gt;</font> would be something like <font face="Courier New">&quot;Default Web Site/&quot;</font> or <font face="Courier New">&quot;Default Web Site/someApp&quot;</font>.&#160; If you manually migrate your <font face="Courier New">Web.config</font> and are still getting migration error messages, here is a snippet you can add right under the <font face="Courier New">system.webServer</font> node to disable the error message:</p>  <p><font face="Courier New">&lt;validation validateIntegratedModeConfiguration=&quot;false&quot; /&gt;</font></p>  <p>Also, I want to make note of something I couldn't get to work that they showed in the tutorial video.&#160; At about the <font face="Courier New">13:50</font> mark in the video, they go into the <font face="Courier New">Modules</font> section of the UI.&#160; These are the modules of the IIS pipeline for both managed .NET code and unmanaged code.&#160; In order to make their video file hidden behind ASP.NET Forms Authentication, they change a property on two authentication modules to allow these modules to execute on non-managed content as well.&#160; However, this did not work for me for some reason when I was trying to secure HTML pages behind Forms Authentication.&#160; What did work for me (and may have been a drastic solution) was to put the following attribute on the <font face="Courier New">modules</font> node under <font face="Courier New">system.webServer</font>:</p>  <p><font face="Courier New">&lt;modules runAllManagedModulesForAllRequests=&quot;true&quot; /&gt;</font></p>  <p>I believe the issue in my case was their was another few managed modules that I needed to clear that checkbox for in the UI.&#160; But I didn't take the time to find out which ones I was missing and opted for the drastic solution.&#160; I will also say there is a way to configure these managed modules through your <font face="Courier New">Web.config</font> so you don't have to have your IT Admin configure properties manually in the UI.&#160; In fact, it seems that much of IIS 7 configuration for your website can be done this way.</p>  <h3>A Few Error Messages (and Their Solutions)</h3>  <p>If you get error messages while using the IIS Manager user interface like this...</p>  <blockquote>   <p>&quot;This feature cannot be used because the default provider type could not be determined to check whether it is a trusted provider.</p>    <p>&quot;You can use this feature only when the default provider is a trusted provider.&#160; If you are a server administrator, you can make a provider a trusted provider by adding the provider type to the trusted providers list in the Administration.config file.&#160; The provider has to be strongly typed and added to the GAC (Global Assembly Cache).&quot;</p> </blockquote>  <p>...then you should visit the following article for detailed information about resolving the error message:</p>  <ul>   <li><a href="http://www.iis.net/ConfigReference/system.webServer/management/trustedProviders/add">Adding Management Trusted Providers &lt;add&gt;</a> </li> </ul>  <p>Getting rid of this error message is really only for convenience in letting the IIS Manager UI be able to query your database using your providers and give you a basic view of your Membership, Roles, and Profile fields.&#160; Also, if you are trying to find your <font face="Courier New">Administration.config</font> file, it is likely located under the <font face="Courier New">C:\Windows\System32\inetsrv\config\</font> folder.</p>  <p>The other error message I received was not in the IIS Manager UI, but rather when you attempt to view your website in a browser (after you think you got all the configuration bugs out!).&#160; A <font face="Courier New">BadImageFormatException</font> is thrown and the error details say something like this:</p>  <p><font face="Courier New">Could not load file or assembly 'AssemlyNameHere' or one of its dependencies.&#160; An attempt was made to load a program with an incorrect format.</font></p>  <p>The likely cause of this error is that the assembly referenced in the error message was compiled only for 32-bit machines and you are running a 64-bit operating system.&#160; With Windows Server 2008 x64, the application pools in IIS have an <font face="Courier New">Advanced Setting</font> called <font face="Courier New">Enable 32-Bit Applications</font>, that is disabled by default.&#160; Enable this setting and you're probably good to go.&#160; See the following link for more detailed information and some nice screenshots:</p>  <ul>   <li><a href="http://blog.crowe.co.nz/archive/2007/11/05/Could-not-load-file-or-assembly-name-or-one-of.aspx">Could not load file or assembly 'name' or one of its dependencies</a> </li> </ul>  <h3>Additional Reading</h3>  <p>I just barely noticed that <a href="http://www.4guysfromrolla.com/">4GuysFromRolla.com</a> recently posted an article about the exact same stuff I was attempting to explain.&#160; To read additional details about IIS 7's Integrated Pipeline and ASP.NET Forms Authentication with static content, check out the following link:</p>  <ul>   <li><a href="http://aspnet.4guysfromrolla.com/articles/122408-1.aspx">Apply ASP.NET Authentication and Authorization Rules to Static Content with IIS 7.0's Integrated Pipeline Feature</a> </li> </ul>  <h3>Conclusion</h3>  <p>I hope you've enjoyed <a title="ASP.NET Providers - Membership, Role, and Profile" href="http://murrayon.net/2009/01/aspnet-providers-membership-role-and.html">this series on the ASP.NET Provider System</a>.&#160; My desire is that you've found these posts helpful in getting you started with implementing such a versatile and customizable model for adding common membership and authorization functionality to your new and existing websites.&#160; There are quite a few advantages in hosting your site on IIS 7 in Windows Server 2008, as I've outlined in this specific post.&#160; Hopefully these discussions about errors and gotchas will also help you get going in no time!</p> </span>  </div>


<h2>Comments</h2>


<div class='comments'>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Thanks. Awesome job.</div>
</div>
<div class='comment'>
<div class='author'>Tony</div>
<div class='content'>
Prefect article and thanks for the video links. It helped me understand this whole integrated vs classic iis7 mode and was a refresher on forms authenication.</div>
</div>
<div class='comment'>
<div class='author'>Radek</div>
<div class='content'>
Thanks. This post helped me resolved serious issue with IIS7</div>
</div>
</div>

]]></content>
  </entry>
  
</feed>
