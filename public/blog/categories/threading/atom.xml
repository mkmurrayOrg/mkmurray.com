<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Threading | Mike Murray]]></title>
  <link href="http://mkmurray.com/blog/categories/threading/atom.xml" rel="self"/>
  <link href="http://mkmurray.com/"/>
  <updated>2012-11-18T20:59:16-07:00</updated>
  <id>http://mkmurray.com/</id>
  <author>
    <name><![CDATA[Mike Murray]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Parallel.For Loops in .NET 4]]></title>
    <link href="http://mkmurray.com/blog/2010/06/12/parallel-for-loops-in-net-4/"/>
    <updated>2010-06-12T12:19:00-06:00</updated>
    <id>http://mkmurray.com/blog/2010/06/12/parallel-for-loops-in-net-4</id>
    <content type="html"><![CDATA[<div class='post'>
<p>I was having fun working on the <a href="http://toughestdeveloperpuzzleever.com/tdpe2/">Toughest Developer Puzzle Ever 2</a> when I came across a problem that asked for the coordinates into a grid of numbers of the upper left corner for a 4x4 sub-grid with a magic sum of 34, meaning all rows, columns, and the 2 diagonals all sum up to 34.&#160; Instead of trying to figure it out manually, I probably did what many programmers would do and wrote a quick and dirty program to accomplish the task for me.</p>  <p>I didn’t try to use any optimized search algorithm or anything, as I knew that the problem space was very small and specific and that computers are really fast.&#160; So I figured I would just write a brute-force iterate through every row and column type of an algorithm (in Big O notation being <font face="Courier New">O(mn)</font> or just <font face="Courier New">O(n<span style="font-size:xx-small; vertical-align:top;">2</span>)</font> if the original grid is square), knowing it would return in milliseconds.</p>  <p>I quickly realized that each iteration was not dependent any previous iteration for its calculations, so I decided it might be a good time to try out the new <font face="Courier New">Parallel.For</font> loops in the .NET 4 Framework that would multi-thread the iterations of the loops.&#160; Here’s the implementation I threw together:</p> <span class="fullpost">   <pre class="brush: csharp">using System;
using System.Linq;
using System.Threading.Tasks;

namespace Find34Grid
{
    public class Program
    {
        private static readonly int[][] Grid = new []
        {
            new [] {16,3,2,13,15,10,3,6,41,15,14,4,12,8,7,1,12},
            new [] {5,10,22,8,4,5,16,7,9,7,6,12,5,11,10,8,5},
            new [] {9,6,7,12,14,11,2,13,16,3,2,13,15,10,3,6,5},
            new [] {41,15,14,4,12,8,7,2,5,10,11,8,4,5,16,9,15},
            new [] {16,3,2,13,15,10,3,6,15,10,16,2,3,13,16,2,3},
            new [] {5,10,11,8,4,5,16,9,4,5,5,11,10,8,5,11,10},
            new [] {9,6,7,12,14,11,2,13,14,11,9,7,6,12,9,7,6},
            new [] {41,15,14,4,12,8,7,1,12,8,4,14,15,1,14,15,1},
            new [] {9,7,6,12,5,11,10,8,5,11,10,3,6,41,15,14,4},
            new [] {4,14,15,1,9,7,6,12,9,7,5,16,9,9,7,6,12},
            new [] {12,8,13,13,4,14,15,1,4,14,11,2,13,16,3,2,13}
        };

        private const int MagicSum = 34;

        public static void Main(string[] args)
        {
            Parallel.For(0, Grid.Length - 3, i =&gt;
            {
                Parallel.For(0, Grid[i].Length - 3, j =&gt;
                {
                    int[] sums = new []
                    {
                        Grid[i].Skip(j).Take(4).Sum(), // Row 1
                        Grid[i+1].Skip(j).Take(4).Sum(), // Row 2
                        Grid[i+2].Skip(j).Take(4).Sum(), // Row 3
                        Grid[i+3].Skip(j).Take(4).Sum(), // Row 4
                        new [] { Grid[i][j], Grid[i+1][j], Grid[i+2][j], Grid[i+3][j]}.Sum(), // Column 1
                        new [] { Grid[i][j+1], Grid[i+1][j+1], Grid[i+2][j+1], Grid[i+3][j+1]}.Sum(), // Column 2
                        new [] { Grid[i][j+2], Grid[i+1][j+2], Grid[i+2][j+2], Grid[i+3][j+2]}.Sum(), // Column 3
                        new [] { Grid[i][j+3], Grid[i+1][j+3], Grid[i+2][j+3], Grid[i+3][j+3]}.Sum(), // Column 4
                        new [] { Grid[i][j], Grid[i+1][j+1], Grid[i+2][j+2], Grid[i+3][j+3]}.Sum(), // Diagonal 1
                        new [] { Grid[i][j+3], Grid[i+1][j+2], Grid[i+2][j+1], Grid[i+3][j]}.Sum() // Diagonal 2
                    };

                    if (sums.All(x =&gt; x == MagicSum))
                    {
                        Console.WriteLine(&quot;y (row): {0}\nx (column): {1}&quot;, i, j);
                    }
                });
            });

            Console.ReadLine();
        }
    }
}</pre>
<p>Nothing special and certainly did the job.&#160; I didn’t really notice a performance improvement in anyway, but that was expected for such a small problem.&#160; I don’t really expect a whole lot of feedback on such straightforward code, but if there is a cleaner or more efficient way to utilize <font face="Courier New">Parallel.For</font> or <font face="Courier New">Parallel.ForEach</font>, please don’t hesitate to let me know via commenting to this post.&#160; Thanks!</p>
</span></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[BeginInvoke Methods and OneWay Attribute]]></title>
    <link href="http://mkmurray.com/blog/2009/05/21/begininvoke-methods-and-oneway-attribute/"/>
    <updated>2009-05-21T16:29:00-06:00</updated>
    <id>http://mkmurray.com/blog/2009/05/21/begininvoke-methods-and-oneway-attribute</id>
    <content type="html"><![CDATA[<div class='post'>
<p>In a previous post I talked about <a href="http://murrayon.net/2008/01/windows-forms-ui-threading.html">Windows Forms UI Threading</a> using delegates.&#160; Recently I needed to replicate what I had learned, and I happened to do so without reviewing my notes in the former blog post.&#160; Apparently I didn’t remember everything I had learned and became confused over thread invocation techniques, introducing a bug into my thread messaging.&#160; The UI thread was blocking while the background worker thread was processing.</p>  <p>The cause was related to figuring out which <font face="Courier New">BeginInvoke</font> method to call when kicking off the worker thread, the <font face="Courier New">BeginInvoke</font> of the <font face="Courier New">Form</font> object or the <font face="Courier New">BeginInvoke</font> of the delegate.&#160; The answer is the <font face="Courier New">BeginInvoke</font> method of the delegate.&#160; All of the examples linked to in the previous post had it right, but I got it mixed up with making <font face="Courier New">Invoke</font> or <font face="Courier New">BeginInvoke</font> calls from the background thread using the <font face="Courier New">Form</font> object’s version of these methods.&#160; If you don’t care whether your messaging from the background thread is synchronous or asynchronous, then you can use either methods and you can use the ones from the <font face="Courier New">Form</font> object.</p>  <p>The problem is using these <font face="Courier New">Form</font> object methods in order to kick off your background worker thread.&#160; The description of the <font face="Courier New">BeginInvoke</font> method on the <font face="Courier New">Form</font> object states that it <font face="Courier New">“executes the specified delegate asynchronously on the thread that the control’s underlying handle was created on.”</font>&#160; I translate this to mean that calling your <font face="Courier New">Form</font> object’s <font face="Courier New">BeginInvoke</font> will process on your UI thread.&#160; Apparently the delegate <font face="Courier New">BeginInvoke</font> method has no such wording in its description.</p> <span class='fullpost'> <p>Rereading <a title="Safe, Simple Multithreading in Windows Forms, Part 1" href="http://msdn.microsoft.com/en-us/library/ms951089.aspx">this MSDN article</a> from the former post and reading the <font face="Courier New">Form</font> object’s <font face="Courier New">BeginInvoke</font> method description which I quoted above set me straight and got rid of my blocking UI problem (again).</p>  <p>During this research session, I came across another informative resource when trying to figure out what was meant by potential resource leaks when using <font face="Courier New">BeginInvoke</font> with out later calling <font face="Courier New">EndInvoke</font>.&#160; From reading the article, I gather you can substitute the <font face="Courier New">EndInvoke</font> call with the <a title="OneWayAttribute Class" href="http://msdn.microsoft.com/en-us/library/system.runtime.remoting.messaging.onewayattribute.aspx"><font face="Courier New">OneWay</font> attribute</a><font face="Courier New"><font color="#333333"><font face="Verdana"></font></font></font> on the method being invoked, as long as it has a <font face="Courier New">void</font> return signature and no <font face="Courier New">ref</font> nor <font face="Courier New">out</font> parameters.&#160; Please let me know if my interpretation is wrong.&#160; I added the attribute to my code in the applicable spots and have seen no side effects of doing so.&#160; Here is the article on read mentioning this attribute:</p>  <p><a href="http://weblogs.asp.net/rosherove/pages/DefensiveEventPublishing.aspx">Defensive Event Publishing in .NET – Part I</a></p> </span>  </div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[C# Partial Classes Can Enhance Code Organization]]></title>
    <link href="http://mkmurray.com/blog/2008/10/24/c-partial-classes-can-enhance-code-organization/"/>
    <updated>2008-10-24T14:23:00-06:00</updated>
    <id>http://mkmurray.com/blog/2008/10/24/c-partial-classes-can-enhance-code-organization</id>
    <content type="html"><![CDATA[<div class='post'>
<p>Many .NET developers are aware of the idea of partial Classes, as they have existed since .NET 2.0.&#160; The primary purpose is to allow you the developer to share claim on a C# Class with Visual Studio's automated code generators (mainly used by the many designers included in Visual Studio), without the automated code generator stomping all over your code additions every time it runs.&#160; For instance, in a Windows Forms application, you get a code-behind Class where you can put your logic, properties, methods, and event handlers; it is a partial Class of the one Visual Studio's Windows Form designer creates and manages for all the UI objects you dragged around in the designer.&#160; A good summarization of this feature is given by <a title="Bart De Smet&#39;s Blog" href="http://community.bartdesmet.net/blogs/bart/default.aspx">Bart De Smet</a>:</p>  <blockquote>   <p>&quot;In short, partial classes allow you to split the definition of a class across multiple files, or alternatively you could think about it as a code compilation unit separated over multiple files.&quot;</p> </blockquote>  <p>As another practical application of this feature, I have occasionally implemented a practice using partial Classes that I learned from a previous coworker.&#160; Occasionally you find yourself with a Class that is inescapably large.&#160; Perhaps it is a web service that has been in use for a while by customers or other groups within your company, and you can't just deprecate the service very easily; so you just keep extending it and adding more web methods to it for additional, similar functionality.&#160; Another potential situation could be that you began designing a simple application all in one file but it grew to be a little bigger than expected, but it doesn't quite merit a whole major redesign into appropriate classes.&#160; I know how this all sounds, but these scenarios aren't exactly uncommon in real-world practice, where there are other factors in consideration.&#160; I suppose many would resort to <a href="http://msdn.microsoft.com/en-us/library/9a1ybwek.aspx">C# <font face="Courier New">regions</font></a>, but I'm not a fan of them as it really only gives the illusion that your code file is better grouped and somehow shorter.</p> <span class='fullpost'> <p>So if you need some decent semblance of organization in a messy class file with little effort, the partial Class feature can come to your rescue.&#160; You can basically create a partial Class file for each grouping of code that you would probably be putting in a C# <font face="Courier New">region</font>.&#160; For instance, a relatively small Windows Form application could be broken up into the following sub-files (all partial Classes of the same <font face="Courier New">MainForm</font> class):</p>  <ul>   <li><strong>MainForm.cs</strong> = contains the constructor and a few rare global enumerations, properties, or sub-classes </li>    <li><strong>MainForm.UI.cs</strong> = contains the event handlers and other supporting methods that interact directly with the UI </li>    <li><strong>MainForm.Processing.cs</strong> = contains the application logic designed to be spun off in a separate worker thread in order to keep the UI thread from blocking while waiting </li>    <li><strong>MainForm.Designer.cs</strong> = the auto-generated UI file from the Windows Form designer </li> </ul>  <p>Obviously you should try to architect your code better from the get-go, but perhaps what you are looking at is legacy code you have inherited from previous developers and the deadline is fast approaching.&#160; There are reasonable circumstances I can think of (and have encountered) where this quick &amp; dirty organization lets you keep an ounce of sanity, so that you can keep moving forward.</p> </span>  </div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Launching MSIExec.exe From C#]]></title>
    <link href="http://mkmurray.com/blog/2008/06/12/launching-msiexec-exe-from-c/"/>
    <updated>2008-06-12T13:21:00-06:00</updated>
    <id>http://mkmurray.com/blog/2008/06/12/launching-msiexec-exe-from-c</id>
    <content type="html"><![CDATA[<div class='post'>
<p>I ran into a problem with trying to spawn off a process to launch an <font face="Courier New">MSIExec.exe</font> command from C#.&#160; I wanted to launch the process and then wait for it to finish before proceeding; however,&#160; it was always returned immediately before the install or uninstall was really finished.&#160; I confirmed this behavior with this blog entry:&#160; <a title="http://blogs.msdn.com/heaths/archive/2005/11/15/493236.aspx" href="http://blogs.msdn.com/heaths/archive/2005/11/15/493236.aspx">http://blogs.msdn.com/heaths/archive/2005/11/15/493236.aspx</a></p>  <p>The author suggests &quot;<font face="Courier New">start /wait</font>&quot; which works from the command line or a batch file.&#160; I did verify it works launching a batch file or two from C#, but I preferred to keep in C# as much as possible.&#160; Also, I was trying to accomplish a silent background process running the <font face="Courier New">MSIExec</font> commands.&#160; However, C# can't just start a process calling &quot;<font face="Courier New">start</font>,&quot; which is an internal command to the Command Prompt I guess.</p>  <p>Someone reminded me on a message board that you can start a process using <font face="Courier New">CMD.exe</font>, calling &quot;<font face="Courier New">start</font>&quot; like this:</p> <span class='fullpost'> <p><pre class="code"><span style="color: #2b91af">ProcessStartInfo </span>startInfo = <span style="color: blue">new </span><span style="color: #2b91af">ProcessStartInfo</span>(
    <span style="color: #a31515">&quot;cmd.exe&quot;</span>,
    <span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;/c start /MIN /wait msiexec.exe /x {0} /quiet&quot;</span>, guid));
startInfo.WindowStyle = <span style="color: #2b91af">ProcessWindowStyle</span>.Hidden;

<span style="color: #2b91af">Process </span>process = <span style="color: #2b91af">Process</span>.Start(startInfo);
process.WaitForExit();</pre></p> <p>It works like a charm.&#160; I don't think you even need the &quot;<font face="Courier New">/MIN</font>&quot; flag for &quot;<font face="Courier New">start</font>&quot; anyway.</p>
</span>  </div>


<h2>Comments</h2>


<div class='comments'>
<div class='comment'>
<div class='author'>Tyler Collier</div>
<div class='content'>
Thanks for this.  Great idea.  Worked for me.</div>
</div>
<div class='comment'>
<div class='author'>chavakiran</div>
<div class='content'>
You could use process.WaitForExit() isn&#39;t it?</div>
</div>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Windows Forms UI Threading]]></title>
    <link href="http://mkmurray.com/blog/2008/01/18/windows-forms-ui-threading/"/>
    <updated>2008-01-18T16:34:00-07:00</updated>
    <id>http://mkmurray.com/blog/2008/01/18/windows-forms-ui-threading</id>
    <content type="html"><![CDATA[<div class='post'>
<p>I fixed a UI issue we were having where some work was being done and it was updating a progress bar, but it wasn't correctly painting the rest of the labels and other static UI elements.&#160; It's best to let the UI do it's thing on the main thread, and then spawn off a worker thread in the background, allowing them to communicate with each other through delegates.</p> <span class='fullpost'> <p>Here is a very nicely done, informative article about delegates that I should have read (I probably would have gotten to my solution quicker and surpassed my trial and error issues):&#160; <a title="http://www.ondotnet.com/pub/a/dotnet/2002/11/04/delegates.htm" href="http://www.ondotnet.com/pub/a/dotnet/2002/11/04/delegates.htm">http://www.ondotnet.com/pub/a/dotnet/2002/11/04/delegates.htm</a></p>  <p>I used the following two articles as a basis for my fix:</p>  <ul>   <li><a title="http://msdn2.microsoft.com/en-us/library/ms951089.aspx" href="http://msdn2.microsoft.com/en-us/library/ms951089.aspx">http://msdn2.microsoft.com/en-us/library/ms951089.aspx</a> </li>    <li><a title="http://www.ondotnet.com/pub/a/dotnet/2003/02/24/asyncdelegates.html?page=1" href="http://www.ondotnet.com/pub/a/dotnet/2003/02/24/asyncdelegates.html?page=1">http://www.ondotnet.com/pub/a/dotnet/2003/02/24/asyncdelegates.html?page=1</a> </li> </ul>  <p>However, I didn't end up using the <font face="Courier New">MulticastDelegate</font> class at all in my solution.&#160; It's not really necessary, and I couldn't get it to work when I tried to extend or inherit from it.&#160; The following article says you can't anyway, unless you are a compiler or some similar tool:&#160; <a title="http://msdn2.microsoft.com/en-us/library/system.multicastdelegate.aspx" href="http://msdn2.microsoft.com/en-us/library/system.multicastdelegate.aspx">http://msdn2.microsoft.com/en-us/library/system.multicastdelegate.aspx</a></p>  <p>This link has a cool helper class for asynchronous delegates, though I didn't use it:&#160; <a title="http://peach.ease.lsoft.com/scripts/wa.exe?A2=ind0302B&amp;L=ADVANCED-DOTNET&amp;T=0&amp;F=&amp;S=&amp;P=31992" href="http://peach.ease.lsoft.com/scripts/wa.exe?A2=ind0302B&amp;L=ADVANCED-DOTNET&amp;T=0&amp;F=&amp;S=&amp;P=31992">http://peach.ease.lsoft.com/scripts/wa.exe?A2=ind0302B&amp;L=ADVANCED-DOTNET&amp;T=0&amp;F=&amp;S=&amp;P=31992</a></p>  <p>Good luck.</p>  <p><strong><u>FOLLOWUP (05/21/09)</u>:&#160; </strong>I have some further clarifications about how to properly invoke delegates to a new background thread in this post:</p>  <p><a href="http://murrayon.net/2009/05/begininvoke-methods-and-oneway.html">BeginInvoke Methods and OneWay Attribute</a></p> </span>  </div>

]]></content>
  </entry>
  
</feed>
